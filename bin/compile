#!/bin/sh
# bin/compile <build-dir> <cache-dir>

BUILD_DIR=$1
CACHE_DIR=$2

VERSION="20120511"
TEXLIVE_URL="https://heroku-buildpack-tex.s3.amazonaws.com/texlive-$VERSION.tar.gz"
TEXLIVE_HOME=$BUILD_DIR/.texlive/dist
DOCUMENT="document.tex"
PATH=$TEXLIVE_HOME/texlive/bin/x86_64-linux:$PATH

# Get a TeX Live distribution suitable for use on Heroku
if [ ! -f "$TEXLIVE_HOME/bin/tex" ]; then
    echo "-----> Fetching TeX Live $VERSION"

    [ ! -d $TEXLIVE_HOME ] && mkdir -p $TEXLIVE_HOME
    curl $TEXLIVE_URL -s -o - | tar xzf - -C $TEXLIVE_HOME
fi

# Check for the existences of a suitable TeX document
cd $BUILD_DIR
if [ ! -f $DOCUMENT ]; then
    echo "-----> $DOCUMENT not found" && exit 1
fi

# Attempt to build the document into a PDF
echo "-----> Building $DOCUMENT"
OUTPUT=`pdflatex $DOCUMENT`

# Bail out if something went wrong
WRITTEN=`echo $OUTPUT | grep "^Output written"`
if [ ! WRITTEN ]; then
    echo $OUTPUT
    exit 1
fi

# Give some feedback to the user
OUTPUT_FILENAME=`echo $WRITTEN | sed 's/.*on \(.\+pdf\).*/\1/'`
PAGES=`echo $WRITTEN | sed 's/.* .\([0-9]\+ pages\?\),.*/\1/'`
OUTPUT_FILENAME=`echo $DOCUMENT | sed s/tex$/pdf/`
echo "       Built $OUTPUT_FILENAME ($PAGES)"
